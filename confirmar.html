<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Confirmar Turno</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  text-align:center;
  background:white;
  font-family:Arial;
}
.logo{
  width:150px;
  margin-top:20px;
}
#reader{
  width:400px;
  margin:auto;
}
#mensaje{
  font-size:24px;
  margin-top:20px;
}
</style>
</head>
<body>

<img src="logo.png" class="logo">

<h2>Confirmar Turno</h2>

<div id="reader"></div>
<div id="mensaje"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "TU_APIKEY",
  authDomain: "turnos-evento.firebaseapp.com",
  databaseURL: "https://turnos-evento-default-rtdb.firebaseio.com",
  projectId: "turnos-evento",
  storageBucket: "turnos-evento.firebasestorage.app",
  messagingSenderId: "108395086341",
  appId: "1:108395086341:web:db50986497b6deb278126c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const qr = new Html5Qrcode("reader");

qr.start(
  { facingMode: "environment" },
  { fps:10, qrbox:250 },
  async (decodedText)=>{

    const data = JSON.parse(decodedText);
    const snapshot = await get(ref(db,"turnos"));

    snapshot.forEach(child=>{
      if(child.val().numero == data.turno){

        if(child.val().estado=="usado"){
          document.getElementById("mensaje").innerHTML="⚠️ YA UTILIZADO";
          document.getElementById("mensaje").style.color="red";
          return;
        }

        update(ref(db,"turnos/"+child.key),{
          estado:"usado",
          horaConfirmado:new Date().toLocaleString()
        });

        // Enviar a Google Sheets
        fetch("https://script.google.com/macros/s/AKfycbx_lYwv392dpfuHrKdCR9Lq2t4cS_D1vc6n0xJgq-ACOvbByuH05-soMbLh1LrNeCjyYw/exec",{
          method:"POST",
          body: JSON.stringify({
            turno:child.val().numero,
            empleado:child.val().empleado,
            nombre:child.val().nombre,
            estado:"usado",
            horaAsignado:child.val().horaAsignado,
            horaConfirmado:new Date().toLocaleString()
          })
        });

        document.getElementById("mensaje").innerHTML="✅ ACCESO PERMITIDO";
        document.getElementById("mensaje").style.color="green";

        new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg").play();
      }
    });

  }
);
</script>

</body>
</html>
