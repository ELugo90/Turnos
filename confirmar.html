<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Confirmar Turno</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "TU_APIKEY",
  authDomain: "turnos-evento.firebaseapp.com",
  databaseURL: "https://turnos-evento-default-rtdb.firebaseio.com",
  projectId: "turnos-evento",
  storageBucket: "turnos-evento.firebasestorage.app",
  messagingSenderId: "108395086341",
  appId: "1:108395086341:web:db50986497b6deb278126c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

window.onload = function(){

const qr = new Html5Qrcode("reader");

qr.start(
{ facingMode:"environment" },
{ fps:10, qrbox:{width:300,height:300} },
async (decodedText)=>{

  const snapshot = await get(ref(db,"turnos"));

  if(snapshot.exists()){
    let encontrado=false;

    snapshot.forEach(child=>{
      if(child.val().numero == decodedText){

        encontrado=true;

        if(child.val().estado=="usado"){
          document.getElementById("status").innerHTML="❌ YA UTILIZADO";
          document.getElementById("status").style.color="red";
        }else{
          update(ref(db,"turnos/"+child.key),{
            estado:"usado",
            horaConfirmado:new Date().toLocaleString()
          });
          document.getElementById("status").innerHTML="✅ ACCESO PERMITIDO";
          document.getElementById("status").style.color="#00ff00";
          new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg").play();
        }
      }
    });

    if(!encontrado){
      document.getElementById("status").innerHTML="❌ TURNO NO EXISTE";
      document.getElementById("status").style.color="red";
    }
  }

});
}
</script>

<style>
body{
  background:#0a192f;
  color:white;
  text-align:center;
  font-family:Arial;
  margin:0;
}

.logo{
  width:180px;
  margin:20px auto;
  display:block;
}

#reader{
  width:95%;
  max-width:600px;
  margin:auto;
}

#status{
  font-size:35px;
  margin-top:20px;
}
</style>
</head>
<body>

<img src="logo.png" class="logo">

<h2>Escanea el QR</h2>

<div id="reader"></div>
<div id="status"></div>

</body>
</html>
