<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asignar Turno</title>

<style>
body{
  font-family: Arial;
  text-align:center;
  margin:0;
  display:flex;
  flex-direction:column;
  min-height:100vh;
  background:white;
}

.contenido{
  flex:1;
}

.logo-top{
  width:150px;
  margin-top:20px;
}

input{
  width:90%;
  max-width:400px;
  padding:10px;
  margin:8px;
  font-size:16px;
}

button{
  padding:12px 20px;
  font-size:16px;
  background:#1565c0;
  color:white;
  border:none;
  border-radius:5px;
  cursor:pointer;
}

#qr{
  margin-top:20px;
}

footer{
  text-align:center;
  padding:15px 0;
}

.logo-footer{
  width:70px;
  display:block;
  margin:0 auto 5px auto;
  opacity:0.9;
}

.derechos{
  font-size:12px;
  color:#555;
}
</style>
</head>

<body>

<div class="contenido">

<img src="logo.png" class="logo-top">

<h2>Solicitar Turno</h2>

<input type="text" id="empleado" placeholder="NÃºmero de empleado" required>
<input type="text" id="nombre" placeholder="Nombre completo" required>

<br>
<button onclick="asignar()">Obtener Turno</button>

<div id="resultado"></div>
<div id="qr"></div>

</div>

<footer>
  <img src="Lugo rojo.png" class="logo-footer">
  <div class="derechos">Derechos reservados.</div>
</footer>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAOmMmesMJ1rpP5gZnJt0w3ZuXK9VmKd9w",
  authDomain: "turnos-evento.firebaseapp.com",
  databaseURL: "https://turnos-evento-default-rtdb.firebaseio.com",
  projectId: "turnos-evento",
  storageBucket: "turnos-evento.firebasestorage.app",
  messagingSenderId: "108395086341",
  appId: "1:108395086341:web:db50986497b6deb278126c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

window.asignar = async function(){

  const empleado = document.getElementById("empleado").value.trim();
  const nombre = document.getElementById("nombre").value.trim();

  if(!empleado || !nombre){
    alert("Completa todos los campos");
    return;
  }

  const snapshot = await get(ref(db,"turnos"));
  let ultimo = 0;

  if(snapshot.exists()){
    snapshot.forEach(child=>{
      if(child.val().numero > ultimo){
        ultimo = child.val().numero;
      }
    });
  }

  const nuevoTurno = ultimo + 1;

  await push(ref(db,"turnos"),{
    numero: nuevoTurno,
    empleado: empleado,
    nombre: nombre,
    estado: "pendiente",
    fechaAsignado: new Date().toLocaleString(),
    fechaConfirmado: ""
  });

  document.getElementById("resultado").innerHTML =
    "<h2>Tu turno es: "+nuevoTurno+"</h2>";

  const qrData = JSON.stringify({turno:nuevoTurno});
  const qrURL = "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data="+encodeURIComponent(qrData);

  document.getElementById("qr").innerHTML =
    "<img src='"+qrURL+"'>";
}

</script>

</body>
</html>
