window.asignarTurno = async function(){

  const empleado = document.getElementById("empleado").value.trim();
  const nombre = document.getElementById("nombre").value.trim();
  const apP = document.getElementById("apPaterno").value.trim();
  const apM = document.getElementById("apMaterno").value.trim();

  if(!empleado || !nombre || !apP){
    alert("Completa los datos");
    return;
  }

  const nombreCompleto = nombre+" "+apP+" "+apM;

  const snapshot = await get(ref(db,"turnos"));

  let yaExiste = false;
  let turnoExistente = null;

  if(snapshot.exists()){
    snapshot.forEach(child=>{
      if(child.val().empleado === empleado){
        yaExiste = true;
        turnoExistente = child.val();
      }
    });
  }

  if(yaExiste){
    alert("Ya tienes un turno asignado");

    document.getElementById("datosEmpleado").innerHTML =
      "Empleado: "+turnoExistente.empleado+
      "<br>"+turnoExistente.nombre+
      "<br>Turno: "+turnoExistente.numero;

    QRCode.toCanvas(document.getElementById("qr"),
      JSON.stringify({turno:turnoExistente.numero, empleado:empleado}),
      {width:250}
    );

    return;
  }

  let nuevoNumero = 1;

  if(snapshot.exists()){
    nuevoNumero = Object.keys(snapshot.val()).length + 1;
  }

  const nuevoTurnoRef = push(ref(db,"turnos"));

  await set(nuevoTurnoRef,{
    numero: nuevoNumero,
    empleado: empleado,
    nombre: nombreCompleto,
    estado: "pendiente",
    horaAsignado: new Date().toLocaleString()
  });

  // ðŸ”¥ Enviar a Google Sheets
  fetch("https://script.google.com/macros/s/AKfycbx_lYwv392dpfuHrKdCR9Lq2t4cS_D1vc6n0xJgq-ACOvbByuH05-soMbLh1LrNeCjyYw/exec",{
    method:"POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      turno:nuevoNumero,
      empleado:empleado,
      nombre:nombreCompleto,
      estado:"pendiente",
      horaAsignado:new Date().toLocaleString(),
      horaConfirmado:""
    })
  });

  document.getElementById("datosEmpleado").innerHTML =
    "Empleado: "+empleado+
    "<br>"+nombreCompleto+
    "<br>Turno: "+nuevoNumero;

  QRCode.toCanvas(document.getElementById("qr"),
    JSON.stringify({turno:nuevoNumero, empleado:empleado}),
    {width:250}
  );
}
